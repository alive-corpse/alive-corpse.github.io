<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="main.css" type="text/css" />
<link rel="stylesheet" href="blog.css" type="text/css" />
<link rel="stylesheet" href="assets/highlight/styles/corpse.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="" href="feed.rss" />
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<script src="assets/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<title>Сам себе хостинг или о недооценённых утилитах</title>
</head><body>
<div id="divbodyholder">
<div class="headerholder">
<a href="https://vk.com/evgeniy_shumilov" target="_blank"><img src="/images/logo.png" class="logo" height="106pt" style="float: left; margin-right: 20px;"></a>
<div class="header">
<div id="title">
<h1 class="nomargin"><a class="ablack" href="https://shumiloff.ru/index.html">Зайчатки разума</a></h1>
<div id="description">Записная книжка айтишника</div>
</div></div>
<ul class="full-width">
    <li>
        <a href="/pro-lyubov-k-minimalizmu-i-staticheskuyu-generaciyu-kontenta.html">О блоге</a>
<!--
        <ul>
            <li><a href="#">Item1</a></li>
            <li><a href="#">Item2</a></li>
            <li><a href="#">Item3</a></li>
        </ul>
-->
    </li>
    <li><a href="/all_tags.html">Теги</a></li>
    <li><a href="/all_posts.html">Все посты</a></li>
    <li><a href="/tag_ностальгия.html">Ностальгическое</a></li>
    <li><a href="/tag_мысли-вслух.html">Мысли вслух</a></li>
</ul>

<div class="ya-site-form ya-site-form_inited_no" onclick="return {'action':'https://yandex.ru/search/site/','arrow':false,'bg':'#b2b525','fontsize':12,'fg':'#000000','language':'ru','logo':'rw','publicname':'Поиск по shumiloff.ru','suggest':true,'target':'_self','tld':'ru','type':3,'usebigdictionary':true,'searchid':2336348,'input_fg':'#999999','input_bg':'#222222','input_fontStyle':'normal','input_fontWeight':'bold','input_placeholder':'Поиск живёт тут','input_placeholderColor':'#787A19','input_borderColor':'#999999'}"><form action="https://yandex.ru/search/site/" method="get" target="_self" accept-charset="utf-8"><input type="hidden" name="searchid" value="2336348"/><input type="hidden" name="l10n" value="ru"/><input type="hidden" name="reqenc" value=""/><input type="search" name="text" value=""/><input type="submit" value="Найти"/></form></div><style type="text/css">.ya-page_js_yes .ya-site-form_inited_no { display: none; }</style><script type="text/javascript">(function(w,d,c){var s=d.createElement('script'),h=d.getElementsByTagName('script')[0],e=d.documentElement;if((' '+e.className+' ').indexOf(' ya-page_js_yes ')===-1){e.className+=' ya-page_js_yes';}s.type='text/javascript';s.async=true;s.charset='utf-8';s.src=(d.location.protocol==='https:'?'https:':'http:')+'//site.yandex.net/v2.0/js/all.js';h.parentNode.insertBefore(s,h);(w[c]||(w[c]=[])).push(function(){Ya.Site.Form.init()})})(window,document,'yandex_site_callbacks');</script>
</div>
<div id="divbody"><div class="content">
<!-- entry begin -->
<h3><a class="ablack" href="sam-sebe-xosting-ili-o-nedoocenyonnyx-utilitax.html">
Сам себе хостинг или о недооценённых утилитах
</a></h3>
<!-- bashblog_timestamp: #201810210049.04# -->
<div class="subtitle">2018-10-21 00:49:04 &mdash; 
Evgeniy Shumilov
</div>
<!-- text begin -->

<i>- Та-ак, а вы что, ещё и права на файлы за меня выдавать будете?<br/>
- Ага-а-а!</i>
<br/>
<img src="/images/mss.png" class="rightimg">
<p>&nbsp;&nbsp;О чём вы думаете, когда слышите аббревиатуру FTP? На меня накатывает ностальгия. Сразу вспоминаются всякие уютные ламповые локалочки, сетевые карты rtl8139, серенькие восьмипортовые коммутаторы D-Link в пластиковых корпусах, папки Public и Private, полные варезом - фильмы, музыка, софт, игры... Одним словом, машинка времени в моей голове телепортирует меня куда-то лет на 15 назад. Много воды утекло с тех пор, но когда кто-то просит совета, как построить себе миниатюрный хостинг, часто в числе прочего я в том или ином виде получаю вопрос: "как поднять FTP"? И каждый раз меня это удивляет. А чем sftp не угодил? Да, это медленнее, но во-первых, скорость интернет соединения сейчас уже не та, что была 15 лет тому, во-вторых, у sftp на борту шифрование и в-третьих, sftp практически всегда уже есть там, где присутствует openssh.</p>
<p>&nbsp;&nbsp;Да, sftp, реализованный средствами OpenSSH не лишён ряда недостатков. Хотелось найти некое решение, которое бы позволило быстро и просто реализовать доступ к машине для разных пользователей, для каждого в свою папку, желательно с chroot. Всё заканчивалось длинными ролями на ансибле, которые переписывали конфиги openssh, добавляли пользователей в нужные гргуппы, ставили пакет управления расширенными правами доступа, дёргали всякие setfacl и прочее. И тут меня попросил мой хороший друг (Иван, спасибо тебе!) помочь ему настроить сервер, а пользователям в качестве шелла поставить MySecureShell. Ранее я с таким зверем не сталкивался, да и ни от кого из моих знакомых за те почти 15 лет, что я общаюсь с linux, не слышал. Судя по всему, это не особо популярное решение. Я бы сказал, незаслуженно обойдённое вниманием. Да вы только посмотрите на их логотип! Похоже, это пингвин, прямо поверх которого начали разводить печатную плату (что похоже, сказалось на его настроении), при этом он ещё кому-то угражает двумя логотипами OpenBSD! Интересно, на каких веществах сидел автор? Ладно, этот вопрос оставим наркологам. Лучше посмотрим в конфигурационный файл. Почитав, что там написано, я понял, что эта штука умеет всё, о чём я мечтал и многое из того, о чём я мечтать не смел.</p>
<hr/>
<h4>Возможности</h4>

<p>&nbsp;&nbsp;Итак, что же умеет эта штука:</p>
<ul>
  <li>при установке в качестве shell, открывает доступ пользователю только по sftp с chroot</li>
  <li>ограничивать upload/download глобально</li>
  <li>ограничивать upload/download для любого пользователя или для группы</li>
  <li>устанваливать таймаут пользователю/группе</li>
  <li>скрывать файлы и директории, к которым нет доступа</li>
  <li>заменять в отображении владельца/группу</li>
  <li>отображать симлинки как то, на что они указывают (это трудно переоценить)</li>
  <li>принудительно указывать кодировку</li>
  <li>вести отдельные логи для пользователя/группы</li>
  <li>указать для любого пользователя или группы дату, до которой активен аккаунт</li>
  <li>ограничить количество коннектов глобально, с одного IP, для одного юзера</li>
  <li>указать дефолтные права на создаваемые файлы/папки (необходимость в acl отпадает)</li>
  <li>указать путь к директории, используя переменные окружения</li>
  <li>так же можно в конфиге дать пользователю права на shell</li>
  <li>можно инклудить конфигурационные файлы</li>
  <li>можно задавать параметры и настройки так же для диапазонов адресов</li>
</ul>
<p>&nbsp;&nbsp;Ещё в конфигурационном файле есть описание неких виртуалхостов. Я подозреваю, что оно ещё каким-то образом определяет, по какому домену вы пришли и в зависимости от этого сможет например, заворачивать ваш коннект в конкретную папку. Не уверен, не проверял - это лишь моё предположение, мне пока и без этого функционала есть, с чем поэкспериментировать. Если честно, то всё это очень впечатляет! Это просто идеальная утилита для решения задачи доступа к файлам в рамках небольшого карманного веб хостинга или если вы хотите использовать какую-нибудь домашнюю raspberry/banana/orange/добавьте-по-вкусу pi в том числе и в качестве файл сервера для синхронизации например, фотографий или документов. А при использовании sshfs такую шару можно вообще подмонтировать куда угодно, в том числе открыть на смартфоне через какой-нибудь X-Plore.</p>

<h4>Переходим к практике</h4>

<pre>sudo apt-get install mysecureshell
sudo vim /etc/ssh/sftp_config</pre>

<p>&nbsp;&nbsp;Файл щедро обмазан комментариями и примерами, но если вам этого недостаточно, то вам сюда: <a href="https://mysecureshell.readthedocs.io/en/latest/index.html" target="_blank">https://mysecureshell.readthedocs.io/en/latest/index.html</a>. Я ниже просто приведу пример того, что осталось в моём конфиге после редактирования и уборки лишних комментариев, это версия с минимальным функционалом, чтобы просто показать, что это работает:</p>

<pre><code class="xml">&lt;Default&gt;
        GlobalDownload          0
        GlobalUpload            0
        Download                500k
        Upload                  0
        StayAtHome              true
        VirtualChroot           true
        LimitConnection         100
        LimitConnectionByUser   10
        LimitConnectionByIP     10
        Home                    /mnt/hd1000/private/$USER/
        IdleTimeOut             5m
        ResolveIP               true
        HideNoAccess            true
        ShowLinksAsLinks        true
	# Так как у нас не демон, а шелл, запускаемый с правами пользователя, 
	# то логи мы сможем класть только в ту директорию, куда у него есть доступ
        LogFile                 /tmp/sftp-server_ftp.log
        Charset                 "UTF8"
&lt;/Default&gt;</code></pre>

<p>&nbsp;&nbsp;А теперь немного изменим и дополним скрипт из предыдущего <a href="/nemnogo-ob-avtomaticheskoj-generacii-parolej.html" target="_blank">поста</a>. Добавим к нему создание директории, которая будет доступна по sftp, выдадим на неё нужные права, уберём генерацию пользовательской директории с дефолтными конфигами и заменим шелл на mysecureshell. Так же реализуем удаление пользователя и предложим выбор - нужно ли удалять директорию с его файлами. В качестве бонуса положим рядом скрипт для логирования из этого <a href="/v-rotejt-mne-logi-pro-minimalizm-busybox-i-logirovanie.html" target="_blank">поста</a>:</p>

<pre><code class="bash">#!/bin/sh
# MySecureShell users generation script by Evgeniy Shumilov &lt;evgeniy.shumilov@gmail.com&gt;

# Расположение пользовательских директорий и дефолтная группа
STORAGE=/mnt/hd1000/private
GROUP=media

# Переходим в директорию, из которой вызван скрипт и загружаем логгер
cd `dirname "$0"`
[ -f "eslogger" ] || wget https://raw.githubusercontent.com/alive-corpse/eslogger/master/eslogger
. ./eslogger

# Проверяем, что скрипт запущен с полными правами, иначе запускаем через sudo 
# c тем же набором параметров ($*), а затем выходим c тем же кодом ($?),
# чтобы не пытаться выполнять содержимое второй раз
if [ `whoami` != "root" ]; then
    l "This script should be started with root privileges, restarting with sudo..."
    sudo $0 $*
    exit $?
fi

# Проверяем наличие mysecureshell и mkpasswd
[ -z "$(which mysecureshell)" ] &amp;&amp; l fe "Can't found mysecureshell binary" 4
[ -z "$(which mkpasswd)" ] &amp;&amp; l fe "Can't found mkpasswd binary (usually part of whois package)" 5

# Добавляем help
help() {
    d
        echo "Appeding new user/users:"
        echo "  Usage: $0 add &lt;username1&gt; [username2] ... [usernameN]"
        echo "  Example: $0 add user1 user2 user3"
        echo
        echo "Removing user/users:"
        echo "  Usage: $0 del &lt;username1&gt; [username2] ... [usernameN]"
        echo "  Example: $0 del user1 user2 user3"
    d
    [ -n "$1" ] &amp;&amp; exit "$1"
    exit 1
}

pwg() {
        [ -z "$1" ] &amp;&amp; len="8" || len="$1"
        tr -dc A-Za-z0-9 &lt; /dev/urandom | head -c "$len" | xargs
}

# Небольшой чит - функция для предоставления пользователю выбора
# Возвращает один из вариантов "y" или "n"
choise() {                                                                                                                                                                   
    ch=''                                                                                                                                                                    
    while [ -z "$(echo "$ch" | sed '/^[yn]$/!d')" ]; do                                                                                                                      
        echo -n "$1 " &gt; /dev/stderr                                                                                                      
        read ch                                                                                                                                                              
    done                                                                                                                                                                     
    echo "$ch"                                                                                                                                                               
} 


addusers() {
    for u in $1; do
        # Заменяем все символы, которые не являются буквами и цифрами на символ "-"
        uname="$(echo "$u" | sed 's/[^a-zA-Z0-9]/-/g')"
    l "Trying to add user $uname..."
        # Берём пароль длиной в 16 символов
        passwd=`pwg 16`
        # Генерируем ещё одну случайную последовательность для соли
        salt=`pwg 8`
        # Получаем хэш пароля
        phash=`echo "$passwd" | mkpasswd -s -m sha-512 -S "$salt"`
        # Пытаемся создать пользователя и выводим информацию об имени и пароле
        if useradd -s /usr/bin/mysecureshell -d "$STORAGE/$uname" -M -p "$phash" -g "$GROUP" "$uname"; then
            l "User $uname is added, password: $passwd"
            # Создаём пользовательскую директорию и выдаём ему права:
            mkdir -p "$STORAGE/$uname"
            chown "$uname:$GROUP" "$STORAGE/$uname"
        else
            l e "Fail to add user $uname"
        fi
    done
}

delusers() {
    for u in $1; do
        uname="$(echo "$u" | sed 's/[^a-zA-Z0-9]/-/g')"
    l "Trying to remove user $uname..."
        # Для начала проверим, что пользователь существует и заодно, что его id &gt; 1000
    # чтобы не удалить какого-нибудь системного пользователя
        uid=`id "$uname" 2&gt;&amp;1`
    if [ -n "$(echo "$uid" | grep -F 'no such user')" ]; then
            l w "User $uname is not exists"
        else
            if [ "$(echo "$uid" | sed 's/^.*uid=//;s/(.*//')" -lt 1000 ]; then
                l w "User $uname has id lower than 1000"
            else
                if deluser "$uname"; then
                    l "User is deleted"
                    # Проверяем, что есть директория и предлагаем её удалить,
                    # будьте с этим осторожны!
                    if [ -d "$STORAGE/$uname" ]; then
            if [ -n "$(choise "Do you want to remove user data (y/n)?") | grep -F 'y'" ]; then
                            l "Removing directory $STORAGE/$uname..."
                            rm -rfv "$STORAGE/$uname"
                        fi
                    fi
                else
                    l e "Fail to delete user $uname"
                fi
            fi
        fi
    done
}


[ -z "$1" ] &amp;&amp; l w "Empty command" &amp;&amp; help 1
[ -z "$2" ] &amp;&amp; l w "Empty user name" &amp;&amp; help 2

users=`echo "$*" | cut -d " " -f 2-`

case $1 in
    add)
        addusers "$users"
    ;;
    del)
        delusers "$users"
    ;;
    *)
        l w "Wrong command $1"
        help 3
    ;;
esac</code></pre>

<h4>Примеры запуска и вывода</h4>

<pre>$ ./mss.sh 
2018.10.20-23:38:28    INFO: This script should be started with root privileges, restarting with sudo...
2018.10.20-23:38:28 WARNING: Empty command
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
Appeding new user/users:
  Usage: ./mss.sh add &lt;username1&gt; [username2] ... [usernameN]
  Example: ./mss.sh add user1 user2 user3

Removing user/users:
  Usage: ./mss.sh del &lt;username1&gt; [username2] ... [usernameN]
  Example: ./mss.sh del user1 user2 user3
=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-

$ ./mss.sh add user1 user2 user3
2018.10.20-23:38:38    INFO: This script should be started with root privileges, restarting with sudo...
2018.10.20-23:38:38    INFO: Trying to add user user1...
2018.10.20-23:38:38    INFO: User user1 is added, password: pU4YerjLw5oeWvFZ
2018.10.20-23:38:38    INFO: Trying to add user user2...
2018.10.20-23:38:38    INFO: User user2 is added, password: iPfZa4ARG5L3IMC1
2018.10.20-23:38:38    INFO: Trying to add user user3...
2018.10.20-23:38:38    INFO: User user3 is added, password: nVogh4myQO1RVjoE

$ ls -lah /mnt/hd1000/private/ | grep user1
drwxr-xr-x  2 user1     media     4.0K Oct 20 23:38 user1

$ ./mss.sh del user2 user3 user4
2018.10.20-23:45:04    INFO: This script should be started with root privileges, restarting with sudo...
2018.10.20-23:45:04    INFO: Trying to remove user user2...
Removing user `user2' ...
Done.
2018.10.20-23:45:05    INFO: User is deleted
Do you want to remove user data (y/n)? y
2018.10.20-23:45:07    INFO: Removing directory /mnt/hd1000/private/user2...
removed directory: ‘/mnt/hd1000/private/user2’
2018.10.20-23:45:07    INFO: Trying to remove user user3...
Removing user `user3' ...
Done.
2018.10.20-23:45:07    INFO: User is deleted
Do you want to remove user data (y/n)? y
2018.10.20-23:45:11    INFO: Removing directory /mnt/hd1000/private/user3...
removed directory: ‘/mnt/hd1000/private/user3’
2018.10.20-23:45:11    INFO: Trying to remove user user4...
2018.10.20-23:45:11 WARNING: User user4 is not exists</pre>

<p>&nbsp;&nbsp;Теперь попробуем с полученным паролем зайти по ssh и по sftp, посмотреть список доступных команд и что-нибудь загрузить.</p>

<pre>$ ssh user1@localhost 
user1@localhost's password: 

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Shell access is disabled !Connection to localhost closed.</pre>

<p>&nbsp;&nbsp;Как видим, по ssh нас не пускает, это хорошо, пробуем sftp</p>

<pre>$ sftp user1@localhost
user1@localhost's password: 
Connected to localhost.
sftp&gt; pwd
Remote working directory: /
sftp&gt; ?
Available commands:
bye                                Quit sftp
cd path                            Change remote directory to 'path'
chgrp grp path                     Change group of file 'path' to 'grp'
chmod mode path                    Change permissions of file 'path' to 'mode'
chown own path                     Change owner of file 'path' to 'own'
df [-hi] [path]                    Display statistics for current directory or
                                   filesystem containing 'path'
exit                               Quit sftp
get [-Ppr] remote [local]          Download file
reget remote [local]               Resume download file
reput [local] remote               Resume upload file
help                               Display this help text
lcd path                           Change local directory to 'path'
lls [ls-options [path]]            Display local directory listing
lmkdir path                        Create local directory
ln [-s] oldpath newpath            Link remote file (-s for symlink)
lpwd                               Print local working directory
ls [-1afhlnrSt] [path]             Display remote directory listing
lumask umask                       Set local umask to 'umask'
mkdir path                         Create remote directory
progress                           Toggle display of progress meter
put [-Ppr] local [remote]          Upload file
pwd                                Display remote working directory
quit                               Quit sftp
rename oldpath newpath             Rename remote file
rm path                            Delete remote file
rmdir path                         Remove remote directory
symlink oldpath newpath            Symlink remote file
version                            Show SFTP version
!command                           Execute 'command' in local shell
!                                  Escape to local shell
?                                  Synonym for help</pre>

<p>&nbsp;&nbsp;Попробуем создать директорию и залить туда в качестве теста тот же самый скрипт, который выполняем.</>

<pre>sftp&gt; mkdir test
sftp&gt; cd test
sftp&gt; lls
eslogger  mss.sh
sftp&gt; put *
Uploading eslogger to /test/eslogger
eslogger                                            100% 3777     3.7KB/s   00:00    
Uploading mss.sh to /test/mss.sh
mss.sh                                              100% 6077     5.9KB/s   00:00    
sftp&gt; ls
eslogger  mss.sh</pre>

<p>&nbsp;&nbsp;Проверим:</p>

<pre>$ ls -lah /mnt/hd1000/private/user1/
total 12K
drwxr-xr-x 3 user1 media 4.0K Oct 20 23:58 .
drwxr-xr-x 6 root  root  4.0K Oct 20 23:45 ..
drwxrwxrwx 2 user1 media 4.0K Oct 20 23:58 test</pre>

<p>&nbsp;&nbsp;Как видите, всё работает. Возможно в одном из следующих постов добавлю в этот скрипт создание структуры директорий и конфигов для nginx как обычно, с шахматами и поэтессами.</p>

<p>&nbsp;&nbsp;Так же скрипт можно взять тут:<p>
<pre><code class="bash">wget https://shumiloff.ru/stuff/mss.sh; chmod +x mss.sh</code></pre>

<p>Теги: <a href='tag_ssh.html'>ssh</a>, <a href='tag_shell.html'>shell</a>, <a href='tag_sftp.html'>sftp</a>, <a href='tag_админское.html'>админское</a></p>





<!-- text end -->
<!-- entry end -->
</div>
<div id="disqus_thread"></div>
            <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
               var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

            /* * * DONT EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
            dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<div id="footer">
<!-- Tolstoy Comments
<script type="text/javascript">!(function(w,d,s,l,x){w[l]=w[l]||[];var f=d.getElementsByTagName(s)[0],j=d.createElement(s);j.async=!0;j.src='//web.tolstoycomments.com/sitejs/app.js?i='+l+'&x='+x+'&t='+(new Date().getTime());f.parentNode.insertBefore(j,f)})(window,document,'script','tolstoycomments','1577');</script>
-->
<a href="https://vk.com/evgeniy_shumilov">Evgeniy Shumilov</a> &mdash; <a href="mailto:evgeniy&#46;shumilov&#64;gmail&#46;com">evgeniy&#46;shumilov&#64;gmail&#46;com</a><br/>
Generated with <a href="https://github.com/cfenollosa/bashblog">bashblog</a>, a single bash script to easily create blogs like this one</div>
</div></div>
</body></html>
</div></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

        /* * * DONT EDIT BELOW THIS LINE * * */
        (function () {
        var s = document.createElement("script"); s.async = true;
        s.type = "text/javascript";
        s.src = "//" + disqus_shortname + ".disqus.com/count.js";
        (document.getElementsByTagName("HEAD")[0] || document.getElementsByTagName("BODY")[0]).appendChild(s);
    }());
    </script>
</body></html>
