<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="main.css" type="text/css" />
<link rel="stylesheet" href="blog.css" type="text/css" />
<link rel="stylesheet" href="assets/highlight/styles/corpse.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="" href="feed.rss" />
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<script src="assets/jquery.min.js"></script>
<script src="assets/jouele/jouele.min.js"></script>
<link href="assets/jouele/jouele.min.css" rel="stylesheet"/>
<script src="assets/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(52451890, "init", {
        id:52451890,
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52451890" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
<title>Про оптимизацию, тишину, эволюцию, нестандартные решения и домашнюю сеть.</title>
</head><body>
<div id="divbodyholder">
<div class="headerholder">
<a href="https://vk.com/evgeniy_shumilov" target="_blank"><img src="/images/logo.png" class="logo" height="106pt" style="float: left; margin-right: 20px;"></a>
<div class="header">
<div id="title">
<h1 class="nomargin"><a class="ablack" href="https://shumiloff.ru/index.html">Зайчатки разума</a></h1>
<div id="description">Записная книжка айтишника</div>
</div></div>
<ul class="full-width">
    <li>
        <a href="/pro-lyubov-k-minimalizmu-i-staticheskuyu-generaciyu-kontenta.html">О блоге</a>
<!--
        <ul>
            <li><a href="#">Item1</a></li>
            <li><a href="#">Item2</a></li>
            <li><a href="#">Item3</a></li>
        </ul>
-->
    </li>
    <li><a href="/all_tags.html">Теги</a></li>
    <li><a href="/all_posts.html">Все посты</a></li>
    <li><a href="/tag_ностальгия.html">Ностальгическое</a></li>
    <li><a href="/tag_мысли-вслух.html">Мысли вслух</a></li>
</ul>

<div class="ya-site-form ya-site-form_inited_no" onclick="return {'action':'https://yandex.ru/search/site/','arrow':false,'bg':'#b2b525','fontsize':12,'fg':'#000000','language':'ru','logo':'rw','publicname':'Поиск по shumiloff.ru','suggest':true,'target':'_self','tld':'ru','type':3,'usebigdictionary':true,'searchid':2336348,'input_fg':'#999999','input_bg':'#222222','input_fontStyle':'normal','input_fontWeight':'bold','input_placeholder':'Поиск живёт тут','input_placeholderColor':'#787A19','input_borderColor':'#999999'}"><form action="https://yandex.ru/search/site/" method="get" target="_self" accept-charset="utf-8"><input type="hidden" name="searchid" value="2336348"/><input type="hidden" name="l10n" value="ru"/><input type="hidden" name="reqenc" value=""/><input type="search" name="text" value=""/><input type="submit" value="Найти"/></form></div><style type="text/css">.ya-page_js_yes .ya-site-form_inited_no { display: none; }</style><script type="text/javascript">(function(w,d,c){var s=d.createElement('script'),h=d.getElementsByTagName('script')[0],e=d.documentElement;if((' '+e.className+' ').indexOf(' ya-page_js_yes ')===-1){e.className+=' ya-page_js_yes';}s.type='text/javascript';s.async=true;s.charset='utf-8';s.src=(d.location.protocol==='https:'?'https:':'http:')+'//site.yandex.net/v2.0/js/all.js';h.parentNode.insertBefore(s,h);(w[c]||(w[c]=[])).push(function(){Ya.Site.Form.init()})})(window,document,'yandex_site_callbacks');</script>
</div>
<div id="divbody"><div class="content">
<!-- entry begin -->
<h3><a class="ablack" href="pro-optimizaciyu-tishinu-evolyuciyu-nestandartnye-resheniya-i-domashnyuyu-set.html">
Про оптимизацию, тишину, эволюцию, нестандартные решения и домашнюю сеть.
</a></h3>
<!-- bashblog_timestamp: #201901210115.09# -->
<div class="subtitle">2019-01-21 01:15:09 &mdash; 
Evgeniy Shumilov
</div>
<!-- text begin -->

<p style="text-align: center;"><img src="images/balcon/1.jpg" /></p>
<p>&nbsp; Достаточно давно я собрал свой первый домашний сервер. И довольно много сил я тогда положил на то, чтобы сделать его как можно более&nbsp;тихим, маленьким и потребляющим минимум энергии. Я сменил радиаторы на процессеоре и северном мосту с целью увеличить площадь рассеивающей поверхности. Я искал самые тихие кулеры, я занижал частоту процессора, я сменил кулер в блоке питания и жёсткий диск я выбирал тоже исходя из теж же требований - тихий и потребляющий минимум энергии. В конце-концов, я <a href="/kunstkamera-drevesnostruzhechnoj-promyshlennosti-ili-mdf-neadekvatnost.html" target="_blank">переместил свой сервер в диван</a>. Мне тогда нужна была платформа для экспериментов и само-собою подразумевалось, что она будет работать 24 часа, 7 дней в неделю.</p>
<p>&nbsp; Зачем <span style="text-decoration: line-through;">не</span>нормальному человеку может быть нужен сервер? Во-первых, это файлопомойка; во-вторых, это медиакомбайн, соединённый с музыкальным центром и имеющий доступ ко всем твоим аудиозаписям, а заодно и к нескольким десяткам онлайн радиостанций; в-третьих файрвол, позволяющий тонко управлять различными подключениями и роутингом между двумя провайдерами и рабочей сетью; в-четвёртых - VPN; в пятых... Продолжать можно долго.</p>
<hr/>
<p>&nbsp; У меня был свой джаббер сервер с кучей подключенных транспортов, через который я общался при помощи одной программы одновременно с людьми в ICQ, Vkontakte, MSN (да, была пара и таких оригиналов), GoogleTalk, IRC, Skype и том же джаббере. Это было крайне удобно - все люди были распределены по вложенным директориям, находились в одном мессенджере и если я знал какого-то условного Васю, потому что мы с ним учились и в университете и одновременно были коллегами, то Вася находился сразу в двух группах или двух папках, если так проще. Ума не приложу, почему такой прогрессивный мессенджер, как телеграм, не позволяет произвольно группировать контакты? Это же&nbsp;крайне полезная, очевидная и удобная функция, да и в реализации вряд ли она так уж сложна. Только представьте, что вместо VK, Facebook, Skype, Telegram, Viber и Watsup у вас бы стояло всего одно приложение на домашней машине и одно на смартфоне. Пусть, оно не поддерживало бы всех функций (например, звонков в skype), но вы могли бы всегда как минимум написать человеку без необходимости держать зоопарк мессенджеров. В принципе, и сейчас такое возможно, но требует некоторых усилий в реализации.</p>
<p>&nbsp; Так вот, джаббер был тогда тем, чем сейчас является телеграм - прогрессивным мессенджером для гиков. Неудивительно, что под джаббер существовали боты. В том числе ботов тогда писал и я,&nbsp;мне это было интересно. Я мог написать с телефона (да-да, с какого-нибудь Siemens S55 через джаббер ява-клиент) что-нибудь вроде "сделай бекап важного", "поставь металлику, сделай тише на 5", или "включи третий компьютер", бот реагировал ожидаемым образом. Так же он слал мне сообщения со статистикой по батарее на UPS, если в квартире отключали питание.&nbsp;</p>
<p>&nbsp; Были так же и некоторые неочевидные фичи. Раз в&nbsp;минуту бот от моего имени заходил в VK, смотрел статус моей бывшей девушки - в сети ли она, в случае, если она была не в сети и стала online, бот делал запись в базу, останавливал музыку, если таковая проигрывалась через музыкальный центр, запоминал уровень громкости, увеличивал громкость, через синтезатор речи&nbsp;и тот же музыкальный центр произносил фразу о том, что она вышла в сеть и точное время (естественно, учитывая время суток, ночью бот молчал),&nbsp;зажигал зелёный светодиод, приклеенный на скотч к шкафу, отправлял мне сообщение в джаббер, восстанавливал уровень громкости и запускал проигрывание музыки с того же места, на котором остановился. В случае, если девушка была в сети, но вышла, происходил аналогичный процесс, а по запросу статистики, бот символами рисовал график количества часов, проведённых ей в сети на последние две недели. Так как в сеть все тогда преимущественно выходили из дома, то зелёный индикатор на шкафу говорил о том, что девушка уже дома, если же я вернулся с работы и увидел, что зелёного огонька нет, то я звонил ей и спрашивал, не нужно ли забрать её с учёбы и увезти домой. Удобно. Так же начинал писать фичу, но не успел её закончить.&nbsp;По задумке - если текущая дата приближалась к сессии, а девушка в контакте залипала дольше пяти часов в сутки на протяжении более двух дней, её маме должна была уходить смска с подключенного к серверу через COM-порт старого телефона Nokia - "ваша дочь мало готовится к экзаменам, примите меры". Если на работе случалась проблема, то на шкафу загорался уже красный огонёк и синтезатор речи вещал списки IP адресов недоступного сетевого оборудования.</p>
<p>&nbsp; Ну вот, опять ударился в ностальгию. Вернёмся к нашим домашним серверам. С тех пор прошло больше 10 лет. Но только пару лет назад прогресс&nbsp;дошёл до того, о чём я давно мечтал - до бесшумного домашнего сервера за разумные деньги. Интел стала выпускать процессоры современной AMD64 архитектуры по 14-ти нанометровой технологии. Это означает, что их температура заметно снизилась, а эффективность - наоборот, повысилась. Всякие Celeron N3XXX/N4XXX/N5XXX вполне замечательно работают без активного охлаждения, а их энергопотребление позволяет обойтись небольшими и, что самое главное, опять же безвентиляторными блоками питания, такими, какие используются в ноутбуках. Жёстким дискам на смену активно приходят SSD, которые так же можно условно считать бесшумными, особенно если сравнивать с HDD. Производительности какого-нибудь китайского неттопа стоимостью в 12 - 15 тысяч рублей вполне достаточно для любых моих нужд. Docker контейнеры с PET-проектами и пачкой различных сервисов? Пожалуйста! Файлопомойка? Легко - вот вам два гигабитных порта и четыре USB 3.0. Поддержка аппаратной виртуализации для экспериментов с какими-нибудь OpenBSD, Kolibri и чем-нибудь более экзотическим? Так же имеется! И всё это работает тихо! ТИХО, КАРЛ!&nbsp;</p>
<p>&nbsp; &nbsp;Но кроме самого домашнего сервера нужно было ещё и что-то, во что он будет подключен. Мне хотелось нормальной управляемой сети с вланами. Раньше у меня был гигабитный управляемый 24-х портовый коммутатор второго уровня. Это был стоечный 19'' гроб, который в глубину был несущественно меньше, чем в ширину. Под ним&nbsp;вполне можно&nbsp;вдвоём укрыться от дождя, а если учитывать его вес, пожалуй, им можно было бы прикрыться и от автоматной очереди не особо опасаясь за своё здоровье. Коммутатор при старте продувал вентиляторы и&nbsp;если при этом закрыть глаза,&nbsp;складывалось ощущение, что ты стоишь посреди взлётной полосы, а на тебя разгоняясь движется взлетающий тяжёлый бомбардировщик. Обошёлся он мне тогда примерно как крыло от вышеупомянутого бомбардировщика. Через несколько секунд&nbsp;коммутатор снижал обороты кулеров, но слышно его было из любой точки квартиры, даже когда он стоял на балконе. Под этот девайс и ещё под несколько других мне пришлось <span style="text-decoration: line-through;">из гуано и веточек</span>&nbsp;уголков перфорированного стеллажа при помощи болагрки и&nbsp;какой-то матери смастерить серверную стойку, которая занимала примерно четверть балкона.&nbsp;</p>
<p>&nbsp; На этот же новый год жена сделала мне подарок - гигабитный управляемый коммутатор второго уровня, который умещается на ладони, кушает 5 вольт 1 ампер и не издаёт никаких звуков!&nbsp;Уровень счастья зашкалил! Но оно не было бы полным, если бы не новая "микросерверная" на балконе.</p>
<p>&nbsp; &nbsp;Не так давно я закончил&nbsp;ремонт на балконе. Точнее, я как ужаленный генерировал нестандартные идеи и решения, а наш ремонтник смотрел на меня глазами полными печали и тоскливо спрашивал "Евгений, а может быть просто ремонт, а?". Одним из таких нестандарных решений как раз оказалось место под множество моих железок. Над входом на балкон по всей ширине была сделана полка, закрывающаяся сдвижными дверками. Ширина и высота полки были тщательно высчитаны так, чтобы она не закрывала из комнаты обзор через окно балкона, не мешала, чтобы к ней был лёгкий доступ, а так же на эту полку заходит из большой комнаты три штробы под провода для будущего управления умным домом, а заодно и сеть. И вот, сегодня звёзды сошлись и я наконец-то ввёл в строй новый коммутатор и перенёс сервер. То, что раньше занимало кучу места, уместилось на одной половине одной полки! Одну фотографию результата я поставил в начало поста, остальные тут:</p>
<p style="text-align: center;"><img src="images/balcon/2.jpg"></p>
<p>&nbsp; Снизу - отличная вещь, которая стОила бы отдельного поста, но&nbsp;если уж она попалась тут, расскажу о ней вкратце. Это <a href="http://ali.pub/31u2ph" target="_blank">Broadlink MP1</a> - управляемый блок из 4-х розеток. Каждая розетка управляется отдельно, работает через Wi-Fi, то есть, гейты ей не нужны, вместо гейта можно использовать любую *Pi, или в моём случае - домашний сервер. Конечно, у Broadlink есть своё приложение для телефона, но добрые люди смогли реверс инжинирингом разобрать протокол передачи данных и теперь этим и некоторыми другими устройствами Broadlink можно <a href="https://github.com/mjg59/python-broadlink" target="_blank">пользоваться напрямую с помощью того же Python</a>. Ниже приведу пример использования:</p>
<pre><code class="python">#!/usr/bin/env python
# -*- coding: utf-8 -*-

import sys
import broadlink

mp1 = broadlink.mp1(host=('10.11.11.18', 80), mac=bytearray(b'Z#\xc1\rC\xb4'))

if mp1.auth():
    if len(sys.argv) &gt; 1:
        for a in sys.argv[1:]:
            if type(a) == str and len(a) == 2:
                if a[0] == '+':
                    mp1.set_power(int(a[1]), True)
                elif a[0] == '-':
                    mp1.set_power(int(a[1]), False)
    stat = mp1.check_power()
    ks = stat.keys()
    ks.sort()
    res = ''
    for s in ks:
        if stat[s]:
            res += '+' + s[1] + ' '
        else:
            res += '-' + s[1] + ' '
    print res.strip()
else:
    sys.stderr('ERROR: Can\'t auth on Broadlink MP1\n')
    sys.exit(1)

sys.exit()
</code></pre>
<p>&nbsp;&nbsp;Уже давно мой сервер по расписанию включает через этот блок розеток док с жёсткими дисками, проверяет файловую систему, прогоняет смарт тест, монитирует разделы, делает на них все необходимые бекапы и затем выключает док. В итоге уже побитые жизнью жёсткие диски используются для второго резервного автоматического бекапа и работают не 24 часа 7 дней в неделю, грея воздух и издавая шум, а всего лишь 15 минут в неделю, что должно увеличить их ресурс в таком режиме на много лет. Так же к серверу подключен один 2.5'' жёсткий диск от сигейт на 4 терабайта и ещё один такой же резервный лежит под ним. При подключении usb (у меня уже есть пара идей о том, как это можно автоматизировать) резервного диска, через udev запускается другой скрипт, который делает все нужные проверки и бекапы. Так как резервный диск работает недолго, то для наименьшего нагрева основного, я поместил резервный под него и использовал силиконовые ножки из хозмага для создания пространства между ними.</p>
<p style="text-align: center;">&nbsp;<img src="images/balcon/3.jpg" /></p>
<p>&nbsp; &nbsp;Упомянутый выше коммутатор крупным планом:</p>
<p style="text-align: center;"><img src="images/balcon/4.jpg" /></p>
<p>&nbsp; Вот как всё выглядит со снятыми для удобства монтажа дверцами:</p>
<p style="text-align: center;"><img src="images/balcon/5.jpg" /></p>
<p>&nbsp; Дверца открыта:</p>
<p style="text-align: center;"><img src="images/balcon/6.jpg" /></p>
<p>&nbsp; Дверца закрыта:</p>
<p style="text-align: center;"><img src="images/balcon/7.jpg" /></p>
<p>&nbsp; &nbsp;Мне кажется, именно умение мыслить нестандартно позволяет делать самые интересные вещи и менять нашу жизнь к лучшему.</p>

<p>Теги: <a href='tag_админское.html'>админское</a>, <a href='tag_automatization.html'>automatization</a>, <a href='tag_networking.html'>networking</a>, <a href='tag_python.html'>python</a></p>
<!-- text end -->
<!-- entry end -->
</div>
<div id="disqus_thread"></div>
            <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
               var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

            /* * * DONT EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
            dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<div id="footer">
<!-- Tolstoy Comments
<script type="text/javascript">!(function(w,d,s,l,x){w[l]=w[l]||[];var f=d.getElementsByTagName(s)[0],j=d.createElement(s);j.async=!0;j.src='//web.tolstoycomments.com/sitejs/app.js?i='+l+'&x='+x+'&t='+(new Date().getTime());f.parentNode.insertBefore(j,f)})(window,document,'script','tolstoycomments','1577');</script>
-->
<a href="https://vk.com/evgeniy_shumilov">Evgeniy Shumilov</a> &mdash; <a href="mailto:evgeniy&#46;shumilov&#64;gmail&#46;com">evgeniy&#46;shumilov&#64;gmail&#46;com</a><br/>
Generated with <a href="https://github.com/cfenollosa/bashblog">bashblog</a>, a single bash script to easily create blogs like this one</div>
</div></div>
</div></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

        /* * * DONT EDIT BELOW THIS LINE * * */
        (function () {
        var s = document.createElement("script"); s.async = true;
        s.type = "text/javascript";
        s.src = "//" + disqus_shortname + ".disqus.com/count.js";
        (document.getElementsByTagName("HEAD")[0] || document.getElementsByTagName("BODY")[0]).appendChild(s);
    }());
    </script>
</body></html>
