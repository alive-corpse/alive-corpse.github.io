<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="main.css" type="text/css" />
<link rel="stylesheet" href="blog.css" type="text/css" />
<link rel="stylesheet" href="assets/highlight/styles/corpse.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="" href="feed.rss" />
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<script src="assets/jquery.min.js"></script>

<script>
  function dLoadScript(url){
    var e = document.createElement("script");
    e.src = url; e.type="text/javascript";
    document.getElementsByTagName("head")[0].appendChild(e); 
  }

  function dLoadCSS(url){
    var e = document.createElement("link");
    e.href = url; e.rel = "stylesheet"; e.type = "text/css";
    document.getElementsByTagName("head")[0].appendChild(e); 
  }

  onload = function() { 
    var element = document.getElementById("ngy2p");
    if(typeof(element) != 'undefined' && element != null){
      dLoadCSS("/assets/nanogallery2/nanogallery2.min.css");
      dLoadScript("/assets/nanogallery2/jquery.nanogallery2.min.js");
    }
  }
</script>

<script src="assets/jouele/jouele.min.js"></script>
<link href="assets/jouele/jouele.min.css" rel="stylesheet"/>
<script src="assets/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(52451890, "init", {
        id:52451890,
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52451890" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
<title>Для чего нужны старые android смартфоны на самом деле</title>
</head><body>
<div id="divbodyholder">
<div class="headerholder">
<a href="https://vk.com/evgeniy_shumilov" target="_blank"><img src="/images/logo.png" class="logo" height="106pt" style="float: left; margin-right: 20px;"></a>
<div class="header">
<div id="title">
<h1 class="nomargin"><a class="ablack" href="https://shumiloff.ru/index.html">Зайчатки разума</a></h1>
<div id="description">Записная книжка айтишника</div>
</div></div>
<ul class="full-width">
    <li>
        <a href="/pro-lyubov-k-minimalizmu-i-staticheskuyu-generaciyu-kontenta.html">О блоге</a>
<!--
        <ul>
            <li><a href="#">Item1</a></li>
            <li><a href="#">Item2</a></li>
            <li><a href="#">Item3</a></li>
        </ul>
-->
    </li>
    <li><a href="/all_tags.html">Теги</a></li>
    <li><a href="/all_posts.html">Все посты</a></li>
    <li><a href="/tag_ностальгия.html">Ностальгическое</a></li>
    <li><a href="/tag_мысли-вслух.html">Мысли вслух</a></li>
</ul>

<div class="ya-site-form ya-site-form_inited_no" onclick="return {'action':'https://yandex.ru/search/site/','arrow':false,'bg':'#b2b525','fontsize':12,'fg':'#000000','language':'ru','logo':'rw','publicname':'Поиск по shumiloff.ru','suggest':true,'target':'_self','tld':'ru','type':3,'usebigdictionary':true,'searchid':2336348,'input_fg':'#999999','input_bg':'#222222','input_fontStyle':'normal','input_fontWeight':'bold','input_placeholder':'Поиск живёт тут','input_placeholderColor':'#787A19','input_borderColor':'#999999'}"><form action="https://yandex.ru/search/site/" method="get" target="_self" accept-charset="utf-8"><input type="hidden" name="searchid" value="2336348"/><input type="hidden" name="l10n" value="ru"/><input type="hidden" name="reqenc" value=""/><input type="search" name="text" value=""/><input type="submit" value="Найти"/></form></div><style type="text/css">.ya-page_js_yes .ya-site-form_inited_no { display: none; }</style><script type="text/javascript">(function(w,d,c){var s=d.createElement('script'),h=d.getElementsByTagName('script')[0],e=d.documentElement;if((' '+e.className+' ').indexOf(' ya-page_js_yes ')===-1){e.className+=' ya-page_js_yes';}s.type='text/javascript';s.async=true;s.charset='utf-8';s.src=(d.location.protocol==='https:'?'https:':'http:')+'//site.yandex.net/v2.0/js/all.js';h.parentNode.insertBefore(s,h);(w[c]||(w[c]=[])).push(function(){Ya.Site.Form.init()})})(window,document,'yandex_site_callbacks');</script>
</div>
<div id="divbody"><div class="content">
<!-- entry begin -->
<h3><a class="ablack" href="dlya-chego-nuzhny-starye-android-smartfony-na-samom-dele.html">
Для чего нужны старые android смартфоны на самом деле
</a></h3>
<!-- bashblog_timestamp: #202009300025.56# -->
<div class="subtitle">2020-09-30 00:25:56 &mdash; 
Evgeniy Shumilov
</div>
<!-- text begin -->

<p style="text-align:center"><img alt="" src="images/megafonlogin.jpg" /></p>

<p>&nbsp; А теперь немного о нестандартном применении стандартных вещей. У моей маман как-то раз полгода тому отказал телефон (MegaFon Login +). Был он куплен в 2015-м году по акции мегафона за 2500 рублей, кажется. Точнее, по акции он продавался за 3990, а я купил у сотрудника мегафона за 2500. Был разлочен с мегафона, затем в корпусе вырезано было дополнительное отверстие, что позволило получить доступ ко второй симкарте. Мегафон просто взял один китайский OEM телефон с непроизводимым названием, заребрендил прошивку, закрыл один слот пластиковой панелью и выпустил это всё на рынок по рекордно низкой цене. В итоге за свои 2500 рублей телефон проработал 4 с лишним года, после чего у него отказал динамик (он и разговорный и не очень - просто меняется сила звука в зависимости от варианта использования). Для маман был приобретён новый телефон, а мегафон до поры/времени выложен на полку. Ремонтировать это чудо бессмысленно, динамик найти и поставить будет стоить почти столько же, за сколько я весь смартфон приобрёл новым, да и производительность у него уже давно не соответствует требованиям времени. Продать такой старый смартфон, с порядочно подсевшим аккумулятором, да ещё и неработающим динамиком тоже вряд ли получится, а если и получится, то за бесценок. Если за него и дадут, то рублей 500, не больше, да и то очень сомнительно.</p>

<p>&nbsp; Но кролики - это не только ценный мех. В конце-концов, смартфон - это отличный ёмкостный дисплей, процессор, память и вообще среда выполнения приложений.</p>

<hr />
<p>&nbsp; Прикрутил я его в качестве панели управления 3д принтером. Поставил Fully Kiosk Browser и телефон в полноэкранном режиме демонстрировал мне тач интерфейс Octorpint. Дешёво, сердито и принтером пользоваться стало намного удобнее. Но был один нюанс - периодически, раз в день-два телефон терял подключение к вайфай и отказывался подключаться к нему снова самостоятельно, а интерфейс он отображал как раз через wifi. Я вяло пытался эту проблему побороть, но в последние пару дней терпение закончилось и я решил взяться за неё серьёзно.</p>

<p>&nbsp; Хотелось в первую очередь достичь независимости от стабильности вайфая или как минимум контролировать его переподключения. Но тут я внезапно обнаружил, что прошивка телефона поддерживает Tethering из коробки. Одним словом, телефон умеет раздавать интернет. Но что ещё лучше, поддерживается RNDIS - т.е. режим раздачи интернета по сети, а сеть представляет из себя эмуляцию ethernet подключения через USB. Это просто отлично! Т.е. телефон одновременно и заряжается по USB и по USB умеет притворяться сетевой картой!</p>

<p>&nbsp; &nbsp;Далее были разбирательства с ADB, чтение форумов, натирание гугла и прочие попытки собрать воедино кусочки разбросанной в разных местах информации. Следующая проблема, с которой я столкнулся - для управления телефоном через USB мне нужно включить режим разработчика и отладку на телефоне. И если режим разработчика сохраняется после перезагрузки, то режим отладки - нет. Сначала я пытался решить проблему через запуск скрипта, включающего ADB через sudo с помощью termux boot - не получилось, так не работает. Но потом я нашёл <a href="https://h4des.org/blog/index.php?/archives/359-Android-LineageOS-16-Execute-Script-on-Start-Up.html">замечательную статью</a>. Автор решал в числе прочего и мою задачу. Суть проста. Сначала перемонтируем раздел system в режим чтения-записи:</p>

<pre>
<code class="language-bash">mount -oremount,rw /system</code></pre>

<p>&nbsp; Потом в директории /system/etc/init/ создаём скрипт init_d.rc со следующим содержанием:</p>

<pre>
<code class="language-bash">service init_d /system/bin/sh /system/bin/sysinit
    user root
    group root
    disabled
    oneshot
    seclabel u:r:sudaemon:s0

on property:sys.boot_completed=1 &amp;&amp; property:sys.logbootcomplete=1
    start init_d</code></pre>

<p>&nbsp; А далее в /etc/init.d создаём скрипты нужного нам содержания, которые и будут запускаться при загрузке. Цифра в начале имени&nbsp;отражает приоритет запуска. У меня в этой директории были 00banner и 90userinit, я добавил к ним свой 99setadb. У скрипта нужно сменить группу и права запуска:</p>

<pre>
<code class="language-bash">chgrp shell 99setadb
chmod 755 99setadb</code></pre>

<p>В сам скрипт я добавил как включение отладки, так и режима разработчика (на всякий случай):</p>

<pre>
<code class="language-bash">#!/system/bin/sh
#
# Turn on adb access
# 

settings put global development_settings_enabled 1
settings put global adb_enabled 1</code></pre>

<p>&nbsp; Вот и всё, это оказалось довольно несложно, после запуска сразу включен режим отладки и можно выполнять на стороне смартфона команды через adb shell.</p>

<p>&nbsp; Теперь со стороны моего Orange PI нам нужно запустить скрипт, который выполнит несколько действий:</p>

<pre>
<code class="language-bash"># включаем режим модема
adb shell su -c 'service call connectivity 33 i32 1'
# ждём, пока система опознает новую сетевую карту и получит 
# для неё настройки по DHCP со стороны смартфона
# (у вас цифра 33 может отличаться, это номер сервиса, ищите в гугле)
# лучше сделать более изящно с while и проверкой, но мне лень. :)
sleep 3
# получаем адрес, который нам выдал смартфон        
IP=`ip a s usb0 | sed '/inet /!d;s/^[ \t]*inet //;s/\/.*//'`
# убираем на одноплатнике маршрут по умолчанию, который прописал 
# смартфон в нашу таблицу маршрутизации, мы ведь не хотим ходить 
# в интернет через смартфон без симкарты и с выключенным вайфаем?
sudo ip r d default via 192.168.42.129 dev usb0 proto dhcp metric 100
# добавляем на смартфоне маршрут до серого адреса одноплатника
# тут роутинг не нужен, это не микротик, в рамках одного хоста 
# это будет работать
adb shell su -c "ip r a 10.11.11.26:5000 via $IP"
# открываем на смартфоне браузер с интерфейсом управления принтером
adb shell am start -a android.intent.action.VIEW -d http://10.11.11.26:5000</code></pre>

<p>Для полноты эффекта лучше установить Fully Kiosk Browser. При первом вызове будет запрос, через что открыть, можно также указать, что всегда нужно открывать адреса с помощью Fully Kiosk Browser.</p>

<p>Что ещё можно улучшить?</p>

<p>Можно выключить wi-fi, ибо он нам уже не нужен.&nbsp;</p>

<pre>
<code class="language-bash">adb shell su -c 'svc wifi disable'</code></pre>

<p>Можно к одноплатнику подключить датчик движения и включать дисплей в те моменты, когда рядом кто-то есть. Проверить статус дисплея можно следующим образом:</p>

<pre>
<code class="language-bash">$ adb shell dumpsys power | grep mWakefulness=
  mWakefulness=Asleep 
# Дисплей включен

$ adb shell dumpsys power | grep mWakefulness=
  mWakefulness=Awake
# Дисплей выключен</code></pre>

<p>А нажатие на кнопку питания можно сделать так:</p>

<pre>
<code class="language-bash">adb shell input keyevent KEYCODE_POWER</code></pre>

<p>Далее если расположить телефон таким образом, чтобы задняя панель была направлена на модель, то можно получить дополнительный источник освещения в виде вспышки. Скажем, чтобы не включая сам принтер включить вспышку на телефоне и через октопринт посмотреть на распечатанную модель (основной источник освещения принтера у меня запитан параллельно с основным блоком питания и гаснет через 10 минут после окончания печати).Управление всякого рода подсветкой - индикаторами, вспышкой и прочим, лежит обычно в /sys/class/leds/. На других телефонах там есть всё - и подсветка кнопок и вспышка, а на Sony Xperia Ultra, помнится, можно было управлять индикатором уведомлений, он был rgb и в файл, соответствующий имени каждого цвета можно было записать любое значение от 0 до 255. Так что можно было выставить любой из 65536 цветов. Зачем это индикатору уведомлений - без понятия. Тем более, что напрямую из интерфейса самого смартфона с такой тонкостью им было управлять невозможно, либо я просто не нашёл этих настроек.&nbsp;<br />
Вот содержимое с Xiaomi Mi4:</p>

<pre>
<code>blue               green          led:flash_1      mmc1::       wled:backlight  
button-backlight   lcd-backlight  led:flash_torch  red          
button-backlight1  led:flash_0    mmc0::           torch-light</code></pre>

<p>Для мегафон логина не нашёл, там только яркость подсветки экрана. Так что прикручу потом освещение на отдельный канал реле. Просто знайте, что для большинства телефонов можно включить вспышку через adb shell -c &#39;echo 255 &gt; /sys/class/leds/led:flash_torch/brightness&#39;. У вас этот путь может отличаться.&nbsp;</p>

<p>Плюс можно пользоваться и камерой телефона. Есть отличное приложение - IP Webcam. Оно позволяет через вебинтерфейс настроить кучу параметров, управлять фокусом, получить поток прямо в нужном формате и фактически мы можем использовать тот же самый телефон вместо камеры, которая отдельно будет стоить ещё рублей 600-700. Одна беда - на том же MegaFon Login + автозапуск этого приложения не работает нормально - после старта камера вылетает. Значит, нужно поймать интент запускаемого андроид приложения и потом запустить при необходимости его самостоятельно.</p>

<pre>
<code class="language-bash">adb logcat | grep -F ActivityManager</code></pre>

<p>Открываем приложение, в консоли несколько раз нажимаем Enter, чтобы отделить текущий поток логов от того, что нам необходимо найти и нажимаем в приложении кнопку &quot;Запустить&quot;</p>

<pre>
<code>09-29 23:13:49.770   857   875 I ActivityManager: START u0 {act=android.intent.action.MAIN cmp=com.pas.webcam/.Rolling} from uid 10120 on display 0</code></pre>

<p>Вот он, родной. Пытался запустить, но получил стектрейс.</p>

<pre>
<code class="language-bash">adb shell am start -n 'com.pas.webcam/.Rolling'
Starting: Intent { cmp=com.pas.webcam/.Rolling }
java.lang.SecurityException: Permission Denial: starting Intent { flg=0x10000000 cmp=com.pas.webcam/.Rolling } from null (pid=13398, uid=2000) not exported from uid 10120
....</code></pre>

<p>Тогда проверим, как запускается основной интент приложения.</p>

<pre>
<code class="language-bash">adb shell am start -n 'com.pas.webcam/.Configuration'
Starting: Intent { cmp=com.pas.webcam/.Configuration }</code></pre>

<p>Отлично. В таком случае можно пойти другим, более долгим путём.</p>

<pre>
<code class="language-bash">adb shell am start -n 'com.pas.webcam/.Configuration'
sleep 5
adb shell input keyevent KEYCODE_MOVE_END; sleep 0.5
adb shell input keyevent KEYCODE_MOVE_END; sleep 0.5
adb shell input keyevent KEYCODE_ENTER; sleep 0.5</code></pre>

<p>Проверил, работает. Отправка кейкода клавиши END нужна, потому что после первого ListBox получает фокус и только после второго переходит в конец списка к необходимой кнопке. Кстати, информацию о кейкодах можно почерпнуть из <a href="https://developer.android.com/reference/android/view/KeyEvent">официальной документации</a>.</p>

<p>Теперь желательно бы скрыть приложение с глаз долой.</p>

<pre>
<code class="language-bash">adb shell input keyevent KEYCODE_TAB; sleep 0.5
adb shell input keyevent KEYCODE_DPAD_DOWN; sleep 0.5
adb shell input keyevent KEYCODE_DPAD_DOWN; sleep 0.5
adb shell input keyevent KEYCODE_ENTER; sleep 0.5
adb shell input keyevent KEYCODE_ENTER; sleep 0.5</code></pre>

<p>Эту часть наверное следует вставить до запуска веб интерфейса октопринта. Теперь по локальному адресу, который мы получили ещё в IP= на порту 8080 доступен web интерфейс управления параметрами видеопотока. И аудио оно тоже умеет захватывать. Более того, есть возможность поставить под Win и собрать под Linux драйвера, с помощью которых можно использовать поток с телефона так, будто он идёт с обычной веб камеры, подключенной к вашей локальной машине. Полезная и удобная функция. Если же мы хотим использовать видеопоток в октопринте, то нам нужен mjpeg. Урл на mjpeg потока будет в моём случае тут: http://192.168.42.129:8080/video.</p>

<p>Что ещё осталось? Поднять прокси для видеопотока на октопринте или замапить порт, так как для локальной сети, из которой подключаются к октопринту клиенты, адрес 192.168.42.X будет недоступен, а окторинт просто отдаст тот урл видеопотока, который будет прописан в настройках. Возможно ещё подключить к орандж паю пару микросервоприводов, которые бы позволили управлять позиционированием телефона, чтобы можно было его поворачивать и таким образом менять направление камеры. Ну и смоделировать крепления с учётом расположения сервоприводов...</p>

<p>Кажется, я сегодня немного увлёкся.</p>

<p>Теги: <a href='tag_3d-printing.html'>3d-printing</a>, <a href='tag_android-soft.html'>android-soft</a>, <a href='tag_automatization.html'>automatization</a>, <a href='tag_hardware.html'>hardware</a>, <a href='tag_pi.html'>pi</a>, <a href='tag_shell.html'>shell</a></p>
<!-- text end -->
<!-- entry end -->
</div>
<div id="disqus_thread"></div>
            <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
               var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

            /* * * DONT EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
            dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<div id="footer">
<a href="https://vk.com/evgeniy_shumilov">Evgeniy Shumilov</a> &mdash; <a href="mailto:evgeniy&#46;shumilov&#64;gmail&#46;com">evgeniy&#46;shumilov&#64;gmail&#46;com</a><br/>
Generated with <a href="https://github.com/cfenollosa/bashblog">bashblog</a>, a single bash script to easily create blogs like this one</div>
</div></div>
</div></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

        /* * * DONT EDIT BELOW THIS LINE * * */
        (function () {
        var s = document.createElement("script"); s.async = true;
        s.type = "text/javascript";
        s.src = "//" + disqus_shortname + ".disqus.com/count.js";
        (document.getElementsByTagName("HEAD")[0] || document.getElementsByTagName("BODY")[0]).appendChild(s);
    }());
    </script>
</body></html>
