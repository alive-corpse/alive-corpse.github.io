<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="main.css" type="text/css" />
<link rel="stylesheet" href="blog.css" type="text/css" />
<link rel="stylesheet" href="assets/highlight/styles/corpse.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" title="" href="feed.rss" />
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<script src="assets/jquery.min.js"></script>
<script src="assets/jouele/jouele.min.js"></script>
<link href="assets/jouele/jouele.min.css" rel="stylesheet"/>
<script src="assets/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(52451890, "init", {
        id:52451890,
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52451890" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
<title>Про недооценённые утилиты - dufs</title>
</head><body>
<div id="divbodyholder">
<div class="headerholder">
<a href="https://vk.com/evgeniy_shumilov" target="_blank"><img src="/images/logo.png" class="logo" height="106pt" style="float: left; margin-right: 20px;"></a>
<div class="header">
<div id="title">
<h1 class="nomargin"><a class="ablack" href="https://shumiloff.ru/index.html">Зайчатки разума</a></h1>
<div id="description">Записная книжка айтишника</div>
</div></div>
<ul class="full-width">
    <li>
        <a href="/pro-lyubov-k-minimalizmu-i-staticheskuyu-generaciyu-kontenta.html">О блоге</a>
<!--
        <ul>
            <li><a href="#">Item1</a></li>
            <li><a href="#">Item2</a></li>
            <li><a href="#">Item3</a></li>
        </ul>
-->
    </li>
    <li><a href="/all_tags.html">Теги</a></li>
    <li><a href="/all_posts.html">Все посты</a></li>
    <li><a href="/tag_ностальгия.html">Ностальгическое</a></li>
    <li><a href="/tag_мысли-вслух.html">Мысли вслух</a></li>
</ul>

<div class="ya-site-form ya-site-form_inited_no" onclick="return {'action':'https://yandex.ru/search/site/','arrow':false,'bg':'#b2b525','fontsize':12,'fg':'#000000','language':'ru','logo':'rw','publicname':'Поиск по shumiloff.ru','suggest':true,'target':'_self','tld':'ru','type':3,'usebigdictionary':true,'searchid':2336348,'input_fg':'#999999','input_bg':'#222222','input_fontStyle':'normal','input_fontWeight':'bold','input_placeholder':'Поиск живёт тут','input_placeholderColor':'#787A19','input_borderColor':'#999999'}"><form action="https://yandex.ru/search/site/" method="get" target="_self" accept-charset="utf-8"><input type="hidden" name="searchid" value="2336348"/><input type="hidden" name="l10n" value="ru"/><input type="hidden" name="reqenc" value=""/><input type="search" name="text" value=""/><input type="submit" value="Найти"/></form></div><style type="text/css">.ya-page_js_yes .ya-site-form_inited_no { display: none; }</style><script type="text/javascript">(function(w,d,c){var s=d.createElement('script'),h=d.getElementsByTagName('script')[0],e=d.documentElement;if((' '+e.className+' ').indexOf(' ya-page_js_yes ')===-1){e.className+=' ya-page_js_yes';}s.type='text/javascript';s.async=true;s.charset='utf-8';s.src=(d.location.protocol==='https:'?'https:':'http:')+'//site.yandex.net/v2.0/js/all.js';h.parentNode.insertBefore(s,h);(w[c]||(w[c]=[])).push(function(){Ya.Site.Form.init()})})(window,document,'yandex_site_callbacks');</script>
</div>
<div id="divbody"><div class="content">
<!-- entry begin -->
<h3><a class="ablack" href="pro-nedoocenyonnye-utility---dufs.html">
Про недооценённые утилиты - dufs
</a></h3>
<!-- bashblog_timestamp: #202401212331.04# -->
<div class="subtitle">2024-01-21 23:31:04 &mdash; 
Evgeniy Shumilov
</div>
<!-- text begin -->

<p style="text-align:center"><img alt="" src="images/dufs.png" style="height:527px; width:800px" /></p>

<p>&nbsp; Иногда бывает такое, что тебе для конкретной задачи не хватает определённого инструмента. Ты его ищешь, ищешь, ищешь, потом уже устаёшь и перестаёшь искать, а спустя несколько лет случайно натыкаешься на него и понимаешь - вот оно! Именно то, что нужно и именно в том виде, который и требовалось. И тогда радость от обретения куда больше, чем если бы ты нашёл его сразу.</p>

<p>&nbsp; Из таких случаев мне навскидку вспомнилось несколько - <a href="https://shumiloff.ru/sam-sebe-xosting-ili-o-nedoocenyonnyx-utilitax.html">MySecureShell</a> и <a href="https://shumiloff.ru/prostaya-i-bystraya-nastrojka-mesh-vpn-s-pomoshhyu-tinc.html">tinc</a>, о которых я уже писал , lnav, о котором я возможно ещё напишу, mosh и вот, недавно - <a href="https://github.com/sigoden/dufs">dufs</a>.</p>

<hr />
<p>&nbsp; Итак, что же это такое? dufs - это утилита, которая предоставляет доступ к директории с файлами или к конкретному файлу средствами WebDAV, и http/https. Причём есть описанное API, с помощью которого можно легко и просто манипулировать файлами, есть простенький web интерфейс, возможность скачать содержимое директории как архив, создавать и редактировать текстовые файлы, есть также возможность ограничения доступа для различных пользователей. Всё это упаковано в исполнимый файл размером чуть более 4х мегабайт, что в современных реалиях более, чем приемлемо.</p>

<p>&nbsp; Для чего я использую теперь эту утилиту:</p>

<ul>
	<li>отправка собранных iso файлов прямо из скрипта сборки с помощью curl в сторону NAS</li>
	<li>возможность быстро получить доступ к нужной директории на удалённом компьютере или смартфоне</li>
	<li>монтирование удалённых ресурсов в локальную файловую систему прямо через virtualhost и nginx, выступающий в роли reverse proxy</li>
	<li>средство для быстрой возможности удаления просмотренного/прослушанного контента на медиа шаре: посмотрел несколько фильмов - быстро пробежался по списку и поудалял прямо со смартфона сидя на диване</li>
	<li>шара для быстрой синхронизации фотографий со смартфона в рамках локальной сети (наелся уже NextCloud - очень хотелось чего-то попроще и побыстрее)</li>
</ul>

<p>&nbsp; Примеры запуска утилиты приводить не буду, они указаны в README.md проекта достаточно подробно и они достаточно просты. Лучше опишу практическое применение.</p>

<h4>Пример запуска в Docker</h4>

<p>&nbsp; Это просто/удобно/быстро, если нужно поднять например, сетевой ресурс для синхронизации контента со смартфонов. На всякий случай приведу сразу пример запуска двух вариантов контейнера - с самоподписанным ssl сертификатом (на порту 5001) и без него (на порту 5000). Зачем запускать сервис без сертификата, если можно с ним? Элементарно - можно проксировать обращение на него с другого хоста, на котором запущен nginx в режиме reverse proxy.</p>

<p>&nbsp; Создание самоподписанного (self signed) сертификата:</p>

<pre>
<code class="language-bash">openssl req -new -newkey rsa:4096 -x509 -sha256 -days 365 -nodes -out ss.crt -keyout ss.key
</code></pre>

<p>&nbsp; В директории /opt/dufs создам директорию cert и положу файлы сертификата и ключа, полученные в результате выполнения указанной выше команды туда. Далее создаём файл docker-compose.yaml</p>

<pre>
<code class="language-yaml">version: '3.3'
services:
  dufs:
    image: sigoden/dufs
    hostname: dufs
    container_name: dufs
    restart: always
    environment:
      - TZ=Asia/Yekaterinburg
    volumes:
      - './data:/data'
    ports:
      - '5000:5000'
    user: 10001:10001
    command: /data -A --enable-cors -a user1:pass1@/directory1:rw -a user2:pass2@/directory2:rw

    logging:
      driver: "json-file"
      options:
        max-size: "64m"

  dufstls:
    image: sigoden/dufs
    hostname: dufstls
    container_name: dufstls
    restart: always
    environment:
      - TZ=Asia/Yekaterinburg
    volumes:
      - './data:/data'
      - './cert:/cert'
    ports:
      - '5001:5000'
    user: 10001:10001
    command: /data -A --enable-cors --tls-cert /cert/ss.crt --tls-key /cert/ss.key -a user1:pass1@/directory1:rw -a user2:pass2@/directory2:rw

    logging:
      driver: "json-file"
      options:
        max-size: "64m"
</code></pre>

<p>&nbsp; Что сразу может броситься в глаза - использование пароля открытым текстом. Да, в документации из репозитория заявлено, что можно использовать хеши sha-512:</p>

<pre>
<code class="language-bash"># DUFS supports the use of sha-512 hashed password.

# Create hashed password
$ mkpasswd  -m sha-512 -s
Password: 123456
$6$qCAVUG7yn7t/hH4d$BWm8r5MoDywNmDP/J3V2S2a6flmKHC1IpblfoqZfuK.LtLBZ0KFXP9QIfJP8RqL8MCw4isdheoAMTuwOz.pAO/

# Use hashed password
dufs -a 'admin:$6$qCAVUG7yn7t/hH4d$BWm8r5MoDywNmDP/J3V2S2a6flmKHC1IpblfoqZfuK.LtLBZ0KFXP9QIfJP8RqL8MCw4isdheoAMTuwOz.pAO/@/:rw'

# Two important things for hashed passwords:
# 1. Dufs only supports sha-512 hashed passwords, so ensure that the password string always starts with `$6$`.
# 2. Digest authentication does not function properly with hashed passwords.
</code></pre>

<p>&nbsp; Но как видим, нас предупреждают сразу, что аутентификация не будет работать с данным типом паролей. Я проверил с basic авторизацией в web интерфейсе и действительно, не работает. Будем надеяться, что в будущих версиях это исправят. В любом случае я не собираюсь использовать этот сервис в качестве production, а для домашних нужд в закрытой сети и этого более, чем достаточно. Не забудьте изменить соответствующим образом владельца и права на docker-compose.yml, если дорожите этими паролями.</p>

<p>&nbsp; Также обратите внимание на строки &quot;user: 10001:10001&quot; - от имени данного пользователя будет запущен сервис dufs и соответственно доступ он сможет получить лишь к тем директориям и файлам, которые имеют соответствующие uid и gid.</p>

<h4>Использование на мобильном устройстве</h4>

<p>&nbsp; Чем полезен dufs для мобильного приложения - можно использовать его для синхронизации фото, скачанных файлов и любой другой информации или использовать как любой облачный диск. Есть два полезных приложения для этого.</p>

<p>&nbsp; Первое (и это тоже в своём роде недооценённая утилита, но уже для Android) - это FolderSync - масса настроек, односторонняя и двусторонняя синхронизация, маски, привязка к конкретным сетям wifi, планирование - одним словом я этой утилитой пользуюсь уже не помню сколько лет и очень доволен. И да, у неё есть масса поддерживаемых типов удалённого хранилища, WebDAV входит в их число. Так что и какой-нибудь яндекс диск также можно при желании подключить. Самое главное, что делает это приложение - незаметно для меня проводит синхронизацию, ведёт лог синхронизаций и делает это исключительно когда я дома, не пытаясь насиловать 4g соединение.</p>

<p>&nbsp; Второе приложение - X-Plore. Им я пользовался ещё в эпоху расцвета Symbian смартфонов, а это было примерно около 20 лет тому назад. Затем это приложение перекочевало и на Android, чему я был несказанно рад. В нём тоже есть возможность подключить &quot;облачные&quot; сетевые ресурсы, в том числе и по протоколу WebDAV. С мобильного устройства удобно подключиться к шаре извне, когда находишься не дома. Например, если нужно найти какой-нибудь файл или документ, находящийся на домашнем сервере.</p>

<p>&nbsp; Есть правда одно но - у FolderSync есть как бесплатная, так и платная версия. У X-Plore тоже. Я когда-то честно купил и первое и второе из уважения к разработчикам, но в свете санкций теперь честно приобретённое стало недоступно жителям Белоруси и РФ. Для решения этого вопроса тоже существуют различные обходные пути, но приводить их тут я не буду.</p>

<h4>Использование с внешним существующим доменом.</h4>

<p>&nbsp; Я пользуюсь nginx и certbot на недорогой виртуальной машине, к которой мой кластер виртуализации подключен через VPN (всё тот же tinc). Предположим, что у нас есть домен domain.com и мы хотим для доступа к шаре сделать доменное имя sub.domain.com. Для начала создаём вируалхост в /etc/nginx/sites-available/sub.domain.com.conf:</p>

<pre>
<code>server {
    listen 80;
    server_name sub.domain.com;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass http://10.20.30.40:5000;
    }
}
</code></pre>

<p>&nbsp; Очевидно, что dufs в соответствии с данным примером должен у нас быть доступен по адресу 10.20.30.40 и занимать порт по умолчанию 5000.</p>

<p>&nbsp; Далее создаём симлинк на файл конфигурации и проверяем его корректность:</p>

<pre>
<code>ln -s /etc/nginx/sites-available/sub.domain.com.conf /etc/nginx/sites-enabled/sub.domain.com.conf
$ sudo nginx -t
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
$ sudo nginx -s reload
</code></pre>

<p>&nbsp; Создаём let&#39;s encrypt сертификат с помощью certbot (у вас может быть иной способ получения сертификата):</p>

<pre>
<code>certbot -d sub.domain.com --nginx
</code></pre>

<p>&nbsp; Если всё сделано корректно, то после этого из того же X-Plore можно будет подключиться к сетевому ресурсу через webdav с помощью указанного вами логина, пароля и адреса <a href="https://sub.domain.com">https://sub.domain.com</a>. Совсем несложно, верно?</p>

<h4>Монтирование сетевого ресурса в linux</h4>

<p>&nbsp; Как давний приверженец debian-based систем опишу способ для них. Для начала нам потребуется установить пакет davfs2 и добавить пользователя в нужную группу:</p>

<pre>
<code>sudo apt -y update &amp;&amp; sudo apt -y install davfs2
sudo add user davfs2
</code></pre>

<p>&nbsp; Далее необходимо перезагрузиться, чтобы у пользователя фактически появились права соответствующей группы.</p>

<p>&nbsp; Затем нужно раскомментировать в конфигурационном файле /etc/davfs2/davfs2.conf две строки и заменить во второй 1 на 0:</p>

<pre>
<code>dav_group       davfs2
use_locks       0
</code></pre>

<p>&nbsp; Монтируем:</p>

<pre>
<code class="language-bash">$ sudo mount -t davfs -o uid=user,gid=user http://10.20.30.40:5000 /home/user/mnt/share
Please enter the username to authenticate with server
http://10.11.11.201:5000 or hit enter for none.
  Username: user
Please enter the password to authenticate user evgeniy with server
http://10.11.11.201:5000 or hit enter for none.
  Password:  
$
</code></pre>

<p>&nbsp; Проверяем:</p>

<pre>
<code>http://10.20.30.40:5000 on /home/user/mnt/share type fuse (rw,nosuid,nodev,relatime,user_id=10001,group_id=10001,allow_other,max_read=16384,uid=10001,gid=10001,_netdev,helper=davfs)
</code></pre>

<p>&nbsp; Всё, теперь можно работать с ресурсом как с частью локальной файловой системы. Что радует, на работоспособность не влияют кратковременные отключения от сети, например, переключение с точки 2.4GHz на 5GHz, уход в спящий режим и пробуждение и т.п..</p>


<p>Теги: <a href='tag_shell.html'>shell</a>, <a href='tag_instruments.html'>instruments</a></p>
<!-- text end -->
<!-- entry end -->
</div>
<div id="disqus_thread"></div>
            <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
               var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

            /* * * DONT EDIT BELOW THIS LINE * * */
            (function() {
            var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
            dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
            (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
<div id="footer">
<a href="https://vk.com/evgeniy_shumilov">Evgeniy Shumilov</a> &mdash; <a href="mailto:evgeniy&#46;shumilov&#64;gmail&#46;com">evgeniy&#46;shumilov&#64;gmail&#46;com</a><br/>
Generated with <a href="https://github.com/cfenollosa/bashblog">bashblog</a>, a single bash script to easily create blogs like this one</div>
</div></div>
</div></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'shumiloff'; // required: replace example with your forum shortname

        /* * * DONT EDIT BELOW THIS LINE * * */
        (function () {
        var s = document.createElement("script"); s.async = true;
        s.type = "text/javascript";
        s.src = "//" + disqus_shortname + ".disqus.com/count.js";
        (document.getElementsByTagName("HEAD")[0] || document.getElementsByTagName("BODY")[0]).appendChild(s);
    }());
    </script>
</body></html>
